Description: >
    HMarn / Udacity Capstone Project
    This template deploys Nodes.
    
Parameters:
    ID:
        Description: Unique identifier.
        Type: String

    EnvironmentName:
        Description: An environment name that will be prefixed to resource names.
        Type: String
        Default: capstone-project

    SSHKeyName:
        Description: An AMI name for node group instance.
        Type: String
        Default: MY-SSH-KEY-NAME
    
    SecurityGroupId:
        Description: An capacity for node group instance.
        Type: String
        Default: sg-045a1d620d4507230
    
    InstanceToUse:
        Description: An capacity for node group instance.
        Type: String
        Default: t3.micro
    
    AMIToUse:
        Description: EC2 AMI ID
        Type: String
        Default: ami-0ceecbb0f30a902a6

Resources:
    NodesSecurityGroup:
        Type: AWS::EC2::SecurityGroup
        Properties:
            GroupName: !Sub ${EnvironmentName}-nodes-SG
            GroupDescription: Allow port 22 for Nodes
            SecurityGroupIngress:
                - IpProtocol: tcp
                  FromPort: 22
                  ToPort: 22
                  CidrIp: 0.0.0.0/0
                - IpProtocol: tcp
                  FromPort: 3000
                  ToPort: 3000
                  CidrIp: 0.0.0.0/0
            Tags: 
                - Key: Name
                  Value: !Sub ${EnvironmentName}-Nodes-SCG-${ID}
    
    Node1:
        Type: AWS::EC2::Instance
        Properties:
            InstanceType: !Ref InstanceToUse
            SecurityGroups:
                - Ref: NodesSecurityGroup
            KeyName: !Ref SSHKeyName
            ImageId: !Ref AMIToUse
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName}-Node1-${ID}
                - Key: Project
                  Value: !Ref EnvironmentName

    Node2:
        Type: AWS::EC2::Instance
        Properties:
            InstanceType: !Ref InstanceToUse
            SecurityGroups:
                - Ref: NodesSecurityGroup
            KeyName: !Ref SSHKeyName
            ImageId: !Ref AMIToUse
            Tags:
                - Key: Name
                  Value: !Sub ${EnvironmentName}-Node2-${ID}
                - Key: Project
                  Value: !Ref EnvironmentName

Outputs:
    NodesSecurityGroup:
        Description: Security group for worker nodes
        Value: !Ref NodesSecurityGroup
        Export:
            Name: !Sub ${EnvironmentName}-Nodes-SCG-${ID}
    Node1:
        Description: Node1 id
        Value: !Ref Node1
        Export:
            Name: !Sub ${EnvironmentName}-Node1-${ID}
    Node2:
        Description: Node2 id
        Value: !Ref Node2
        Export:
            Name: !Sub ${EnvironmentName}-Node2-${ID}
